name: CD Production

on:
  push:
    tags: ["v*"]

jobs:
  ci:
    uses: ./.github/workflows/ci.yml

  deploy:
    needs: ci
    runs-on: ubuntu-latest

    concurrency:
      group: production-deploy
      cancel-in-progress: false

    environment:
      name: production
      url: https://reify.fly.dev

    env:
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN_PRODUCTION }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for ancestry check

      - name: Validate tag is on main
        run: |
          git fetch origin main

          if ! git merge-base --is-ancestor HEAD origin/main; then
            echo "::error ::Tagged commit is not in main's history. Production releases must be on main."
            exit 1
          fi

          TAG="${GITHUB_REF#refs/tags/}"
          if [[ ! "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error ::Invalid tag format: $TAG (expected vX.Y.Z)"
            exit 1
          fi

          echo "âœ… Valid release tag $TAG on main branch"

      - name: Setup Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy to Production
        run: flyctl deploy --config fly.production.toml --remote-only

      - name: Scale to Multi-Region
        run: |
          flyctl scale count 1 --region iad --app reify --yes
          flyctl scale count 1 --region sjc --app reify --yes
