name: CD Review App

on:
  pull_request:
    types: [opened, reopened, synchronize, closed]

jobs:
  ci:
    if: github.event.action != 'closed'
    uses: ./.github/workflows/ci.yml

  deploy:
    if: github.event.action != 'closed'
    needs: ci
    runs-on: ubuntu-latest

    environment:
      name: review-pr-${{ github.event.pull_request.number }}
      url: https://reify-pr-${{ github.event.pull_request.number }}.fly.dev

    env:
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN_PERSONAL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Create or Deploy Review App
        run: |
          APP_NAME="reify-pr-${{ github.event.pull_request.number }}"

          # Check if app exists
          if ! flyctl status --app "$APP_NAME" 2>/dev/null; then
            echo "Creating new app: $APP_NAME"
            flyctl apps create "$APP_NAME" --org personal

            # Create and attach Postgres
            flyctl postgres create \
              --name "$APP_NAME-db" \
              --org personal \
              --region iad \
              --vm-size shared-cpu-1x \
              --vm-memory 1024 \
              --initial-cluster-size 1 \
              --volume-size 1

            flyctl postgres attach "$APP_NAME-db" --app "$APP_NAME"

            # Wait for postgres DNS to propagate
            echo "Waiting 30s for Postgres DNS propagation..."
            sleep 30

            # Set secrets
            flyctl secrets set \
              SECRET_KEY_BASE="$(openssl rand -hex 64)" \
              PHX_HOST="$APP_NAME.fly.dev" \
              ECTO_IPV6=true \
              --app "$APP_NAME"
          fi

          # Deploy
          flyctl deploy \
            --app "$APP_NAME" \
            --config fly.review.toml \
            --remote-only

  cleanup:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    permissions:
      deployments: write

    env:
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN_PERSONAL }}

    steps:
      - name: Setup Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Destroy Review App
        run: |
          APP_NAME="reify-pr-${{ github.event.pull_request.number }}"
          flyctl apps destroy "$APP_NAME" --yes || true
          flyctl apps destroy "$APP_NAME-db" --yes || true

      - name: Clean Up GitHub Environment
        uses: strumwolf/delete-deployment-environment@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          environment: review-pr-${{ github.event.pull_request.number }}
